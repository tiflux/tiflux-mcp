# Bug Fix: services_catalogs_item_id n√£o estava sendo enviado no update_ticket

## Data: 2025-10-22

## Problema Inicial

O usu√°rio solicitou transferir o ticket #80850 da mesa "DEV - Cansados" para a mesa "DEV - Tuitui".

Ao tentar usar o MCP para fazer a transfer√™ncia com:
```
mcp__tiflux__update_ticket(
  ticket_number: 80850,
  desk_id: 38963,
  services_catalogs_item_id: 1388284
)
```

Receb√≠amos o erro:
```
422 - "This desk requires a services catalog item to open a ticket"
```

## Investiga√ß√£o

### 1. Teste Direto na API TiFlux
Testamos diretamente na API usando curl:

```bash
curl -X PUT 'https://api.tiflux.com/api/v2/tickets/80850' \
  -H 'Authorization: Bearer TOKEN' \
  -H 'Content-Type: application/json' \
  -d '{"desk_id":38963,"services_catalogs_item_id":1388284}'
```

**Resultado**: ‚úÖ Funcionou! O ticket foi transferido com sucesso.

**Conclus√£o**: O problema estava no c√≥digo do MCP, n√£o na API do TiFlux.

### 2. Teste do TicketMapper
Criamos um script de teste para validar o `TicketMapper.mapUpdateToAPI()`:

```javascript
// test-update.js
const mapper = new TicketMapper(mockContainer);
const updateData = {
  desk_id: 42821,
  services_catalogs_item_id: 793519
};
const apiData = mapper.mapUpdateToAPI(updateData);
```

**Resultado**: ‚úÖ O `services_catalogs_item_id` estava presente no output!

### 3. An√°lise do Fluxo de Dados

Rastreamos o fluxo:
```
Handler ‚Üí TicketService ‚Üí TicketValidator ‚Üí TicketRepository ‚Üí TicketMapper ‚Üí API
```

Descobrimos que o problema estava no **TicketValidator**.

## Causa Raiz Encontrada

**Arquivo**: `src/domain/tickets/TicketValidator.js`
**Linha**: 148-152

```javascript
const allowedFields = [
  'title', 'description', 'client_id', 'desk_id', 'priority_id',
  'status_id', 'stage_id', 'responsible_id', 'followers',
  'client_name', 'desk_name'
];
```

O campo `services_catalogs_item_id` **N√ÉO estava na lista `allowedFields`**!

Isso causava o seguinte comportamento (linha 154-156):
```javascript
const providedFields = Object.keys(updateData).filter(key =>
  allowedFields.includes(key) && updateData[key] !== undefined
);
```

O campo era **silenciosamente removido** do payload antes de chegar no TicketMapper.

## Solu√ß√µes Aplicadas

### 1. TicketMapper.js (Linha 156)
J√° havia sido corrigido anteriormente, mas estava sendo bloqueado pelo Validator:

```javascript
const idFields = [
  'client_id', 'desk_id', 'priority_id', 'status_id',
  'stage_id', 'responsible_id', 'services_catalogs_item_id'  // ‚úÖ ADICIONADO
];
```

### 2. TicketValidator.js (Linhas 148-154) - **CORRE√á√ÉO PRINCIPAL**

**Antes**:
```javascript
const allowedFields = [
  'title', 'description', 'client_id', 'desk_id', 'priority_id',
  'status_id', 'stage_id', 'responsible_id', 'followers',
  'client_name', 'desk_name'
];
```

**Depois**:
```javascript
const allowedFields = [
  'title', 'description', 'client_id', 'desk_id', 'priority_id',
  'status_id', 'stage_id', 'responsible_id', 'followers',
  'client_name', 'desk_name', 'stage_name', 'responsible_name',
  'services_catalogs_item_id', 'catalog_item_name',  // ‚úÖ ADICIONADO
  'requestor_name', 'requestor_email', 'requestor_telephone'  // ‚úÖ ADICIONADO
];
```

### 3. TicketValidator.js (Linha 196) - Valida√ß√£o Num√©rica

**Antes**:
```javascript
const numericFields = [
  'client_id', 'desk_id', 'priority_id', 'status_id',
  'stage_id', 'responsible_id'
];
```

**Depois**:
```javascript
const numericFields = [
  'client_id', 'desk_id', 'priority_id', 'status_id',
  'stage_id', 'responsible_id', 'services_catalogs_item_id'  // ‚úÖ ADICIONADO
];
```

### 4. TicketRepository.js (Linhas 161-164) - Log de Debug

Adicionado para facilitar troubleshooting futuro:

```javascript
this.logger.info('Repository: API payload for update', {
  ticketId,
  apiData: JSON.stringify(apiData)
});
```

## Commits Realizados

1. **`5033a15`** - Adicionar services_catalogs_item_id ao TicketMapper e logs de debug
2. **`338fc04`** - Bump version to 1.4.3 - Fix services_catalogs_item_id in update_ticket
3. **`54ac564`** - Fix: Adicionar services_catalogs_item_id aos campos permitidos no TicketValidator
4. **`2fffdc0`** - Bump version to 1.4.4 - Fix TicketValidator allowedFields

## Deploys Realizados

### NPM
- ‚úÖ Vers√£o **1.4.3** publicada (fix no TicketMapper)
- ‚úÖ Vers√£o **1.4.4** publicada (fix no TicketValidator) - **CORRE√á√ÉO FINAL**

### Lambda AWS
- ‚úÖ Deploy 1: 2025-10-22 07:56:37 BRT (10:56:37 UTC)
- ‚úÖ Deploy 2: 2025-10-22 09:22:37 BRT (12:22:37 UTC)
- ‚úÖ Deploy 3: 2025-10-22 09:39:34 BRT (12:39:34 UTC) - **CORRE√á√ÉO FINAL**

## Status Atual

### ‚úÖ C√≥digo Corrigido e Deployado
- C√≥digo fonte corrigido no GitHub
- Publicado no NPM como @tiflux/mcp@1.4.4
- Lambda atualizada e deployada

### ‚è≥ Aguardando Cache da Lambda
As inst√¢ncias antigas da Lambda ainda est√£o em execu√ß√£o. O AWS Lambda mant√©m m√∫ltiplas inst√¢ncias "quentes" que podem estar usando o c√≥digo antigo.

**O que acontecer√°**:
- Inst√¢ncias antigas expiram automaticamente ap√≥s alguns minutos de inatividade
- Novas requisi√ß√µes criar√£o novas inst√¢ncias com o c√≥digo v1.4.4
- Gradualmente todas as chamadas usar√£o o c√≥digo corrigido

### üîß Como Usar Imediatamente

#### Op√ß√£o 1: MCP Local (tiflux-mcp)
Reinicie o Claude Code para recarregar o servidor MCP local com o novo c√≥digo.

#### Op√ß√£o 2: MCP Lambda (tiflux-lambda)
Aguarde 5-10 minutos para as inst√¢ncias antigas expirarem, ou fa√ßa m√∫ltiplas chamadas para for√ßar novas inst√¢ncias.

#### Op√ß√£o 3: Curl Direto (funciona imediatamente)
```bash
curl -X PUT 'https://api.tiflux.com/api/v2/tickets/NUMERO' \
  -H 'Authorization: Bearer SEU_TOKEN' \
  -H 'Content-Type: application/json' \
  -d '{"desk_id":ID_MESA,"services_catalogs_item_id":ID_ITEM}'
```

## Teste de Valida√ß√£o

### Comando para Testar
```javascript
mcp__tiflux_lambda__update_ticket({
  ticket_number: "80850",
  desk_id: 38963,  // DEV - Tuitui
  services_catalogs_item_id: 1388284  // Geral - Bot - Web - Desenvolvimento
})
```

### Resultado Esperado
```
‚úÖ Ticket Atualizado com Sucesso #80850
Mesa: Equipe Tuitui
```

## Informa√ß√µes Importantes

### IDs de Refer√™ncia
- **Ticket testado**: #80850 (Bug de seguran√ßa - SQL injection)
- **Mesa Cansados**: ID 42821
- **Mesa Tuitui**: ID 38963
- **Item de Cat√°logo Cansados**: 793519 (Funcionalidade - Dashboard inicial)
- **Item de Cat√°logo Tuitui**: 1388284 (Geral - Bot - Web - Desenvolvimento)

### Token de Autentica√ß√£o
O token est√° configurado em `~/.bashrc` na linha 277:
```bash
export TIFLUX_API_KEY="eyJhbGci..."
```

## Li√ß√µes Aprendidas

1. **Validadores podem bloquear silenciosamente** - Sempre verificar a lista `allowedFields` quando adicionar novos campos
2. **M√∫ltiplas camadas de valida√ß√£o** - O campo estava correto no Mapper mas bloqueado no Validator
3. **Cache da Lambda** - Inst√¢ncias antigas podem permanecer ativas por v√°rios minutos
4. **Teste direto na API** - Sempre testar com curl para isolar se √© problema do MCP ou da API
5. **Logs de debug** - Adicionar logs do payload enviado facilita muito o troubleshooting

## Pr√≥ximos Passos Recomendados

1. ‚úÖ Aguardar cache da Lambda expirar (5-10 minutos)
2. ‚úÖ Testar novamente via MCP Lambda
3. ‚úÖ Reiniciar Claude Code para usar MCP local atualizado
4. üìù Atualizar documenta√ß√£o da API do MCP
5. üìù Adicionar testes automatizados para valida√ß√£o de campos permitidos
6. üìù Considerar adicionar warning quando campos s√£o removidos pelo validator

## Arquivos Modificados

```
tiflux-mcp/
‚îú‚îÄ‚îÄ src/domain/tickets/
‚îÇ   ‚îú‚îÄ‚îÄ TicketMapper.js          (linha 156) ‚úÖ
‚îÇ   ‚îú‚îÄ‚îÄ TicketValidator.js       (linhas 148-154, 196) ‚úÖ PRINCIPAL
‚îÇ   ‚îî‚îÄ‚îÄ TicketRepository.js      (linhas 161-164) ‚úÖ
‚îú‚îÄ‚îÄ package.json                 (vers√£o 1.4.4) ‚úÖ
‚îú‚îÄ‚îÄ test-update.js              (script de teste) ‚úÖ
‚îî‚îÄ‚îÄ test-validator.js           (script de teste) ‚úÖ
```

## Refer√™ncias

- Issue original: Transfer√™ncia do ticket #80850
- Commits: 5033a15, 338fc04, 54ac564, 2fffdc0
- NPM: https://www.npmjs.com/package/@tiflux/mcp
- Lambda: tiflux-mcp-server (sa-east-1)
- API TiFlux: https://api.tiflux.com/api/v2
